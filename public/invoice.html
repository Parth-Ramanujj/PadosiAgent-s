<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Invoice ‚Äî PadosiAgent ServTech Pvt Ltd</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e73be;
            --primary-dark: #14537e;
            --primary-darker: #0d3a5a;
            --primary-light: #e8f2fc;
            --primary-lighter: #f4f9fe;
            --accent: #3b9ee6;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --green-50: #ecfdf5;
            --green-100: #d1fae5;
            --green-500: #10b981;
            --green-600: #059669;
            --green-700: #047857;
            --yellow-50: #fffbeb;
            --yellow-100: #fef3c7;
            --yellow-500: #f59e0b;
            --yellow-600: #d97706;
            --yellow-700: #b45309;
            --red-50: #fef2f2;
            --red-500: #ef4444;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, .05);
            --shadow: 0 1px 3px rgba(0, 0, 0, .08), 0 1px 2px rgba(0, 0, 0, .06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .08), 0 2px 4px -2px rgba(0, 0, 0, .06);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, .1), 0 8px 10px -6px rgba(0, 0, 0, .06);
            --shadow-xl: 0 20px 50px -12px rgba(0, 0, 0, .18);
            --radius: 10px;
            --radius-lg: 16px;
        }

        html {
            font-size: 14px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(160deg, #e2e8f0 0%, #cbd5e1 100%);
            color: var(--gray-800);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            padding: 32px 20px;
            min-height: 100vh;
        }

        /* ===== Search Panel ===== */
        .search-panel {
            max-width: 820px;
            margin: 0 auto 24px;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 24px 32px;
            position: relative;
        }

        .search-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .search-panel-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-panel-title .icon {
            font-size: 1.3rem;
        }

        .search-panel-subtitle {
            font-size: 0.75rem;
            color: var(--gray-400);
        }

        .search-actions {
            display: flex;
            gap: 10px;
        }

        .btn-print {
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all .2s;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 2px 8px rgba(30, 115, 190, .3);
        }

        .btn-print:hover {
            box-shadow: 0 4px 12px rgba(30, 115, 190, .4);
            transform: translateY(-1px);
        }

        .btn-print:disabled {
            opacity: .4;
            cursor: not-allowed;
            transform: none;
        }

        .search-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 42px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.92rem;
            color: var(--gray-800);
            outline: none;
            transition: border-color .2s, box-shadow .2s;
            background: var(--gray-50);
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 115, 190, .12);
            background: white;
        }

        .search-input::placeholder {
            color: var(--gray-400);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.1rem;
            color: var(--gray-400);
            pointer-events: none;
        }

        .search-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            max-height: 280px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .search-dropdown.open {
            display: block;
        }

        .search-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
            transition: background .15s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-item:last-child {
            border-bottom: none;
        }

        .search-item:hover {
            background: var(--primary-lighter);
        }

        .search-item-left {
            display: flex;
            flex-direction: column;
        }

        .search-item-name {
            font-weight: 600;
            font-size: 0.88rem;
            color: var(--gray-800);
        }

        .search-item-email {
            font-size: 0.72rem;
            color: var(--gray-400);
        }

        .search-item-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-item-amount {
            font-weight: 700;
            font-size: 0.82rem;
            color: var(--primary);
        }

        .search-item-badge {
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 50px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-completed {
            background: var(--green-100);
            color: var(--green-700);
        }

        .badge-pending {
            background: var(--yellow-100);
            color: var(--yellow-700);
        }

        .search-stats {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-100);
        }

        .stat-chip {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            background: var(--gray-100);
            color: var(--gray-500);
        }

        .stat-chip .num {
            color: var(--primary);
            font-weight: 800;
        }

        /* Loading */
        .loading-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gray-100);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            overflow: hidden;
        }

        .loading-bar::after {
            content: '';
            display: block;
            width: 30%;
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 3px;
            animation: loadingSlide 1.2s ease infinite;
        }

        .loading-bar.hidden {
            display: none;
        }

        @keyframes loadingSlide {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(400%);
            }
        }

        /* ===== Invoice Container ===== */
        .invoice-page {
            max-width: 820px;
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            display: none;
            /* hidden until user selected */
        }

        .invoice-page.visible {
            display: block;
        }

        /* ===== Empty State ===== */
        .empty-state {
            max-width: 820px;
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 60px 40px;
            text-align: center;
        }

        .empty-state.hidden {
            display: none;
        }

        .empty-icon {
            font-size: 3.5rem;
            margin-bottom: 16px;
            opacity: .6;
        }

        .empty-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--gray-600);
            margin-bottom: 6px;
        }

        .empty-desc {
            font-size: 0.82rem;
            color: var(--gray-400);
            max-width: 360px;
            margin: 0 auto;
        }

        /* ===== Header ===== */
        .invoice-header {
            background: linear-gradient(145deg, #1a6db5 0%, var(--primary-dark) 50%, var(--primary-darker) 100%);
            color: var(--white);
            position: relative;
            overflow: hidden;
        }

        .invoice-header::before {
            content: '';
            position: absolute;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.03);
            top: -120px;
            right: -60px;
        }

        .invoice-header::after {
            content: '';
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.03);
            bottom: -80px;
            left: -40px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 28px 40px 22px;
            position: relative;
            z-index: 1;
        }

        .company-brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo-container {
            width: 52px;
            height: 52px;
            background: var(--white);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .15);
            flex-shrink: 0;
            overflow: hidden;
        }

        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
        }

        .brand-name {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.3px;
            line-height: 1.2;
        }

        .brand-sub {
            font-size: 0.72rem;
            font-weight: 400;
            opacity: 0.7;
            letter-spacing: 0.3px;
            margin-top: 2px;
        }

        .invoice-title-block {
            text-align: right;
            position: relative;
            z-index: 1;
        }

        .invoice-title {
            font-size: 2.2rem;
            font-weight: 900;
            letter-spacing: 4px;
            text-transform: uppercase;
            line-height: 1;
            opacity: 0.95;
        }

        .invoice-title-sub {
            font-size: 0.72rem;
            opacity: 0.6;
            margin-top: 5px;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        /* Meta Bar */
        .invoice-meta-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            background: rgba(255, 255, 255, 0.08);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
        }

        .meta-item {
            padding: 14px 24px;
            text-align: center;
            border-right: 1px solid rgba(255, 255, 255, 0.08);
        }

        .meta-item:last-child {
            border-right: none;
        }

        .meta-item .m-label {
            font-size: 0.62rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            opacity: 0.55;
            margin-bottom: 3px;
        }

        .meta-item .m-value {
            font-size: 0.92rem;
            font-weight: 700;
            letter-spacing: 0.2px;
        }

        /* ===== Body ===== */
        .invoice-body {
            padding: 32px 40px;
        }

        /* Detail Cards */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .detail-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 20px 22px;
            transition: box-shadow .2s;
        }

        .detail-card:hover {
            box-shadow: var(--shadow-md);
        }

        .detail-card .card-header {
            font-size: 0.68rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.4px;
            color: var(--primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary-light);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-header-icon {
            font-size: 0.9rem;
        }

        .detail-card .card-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .detail-card .card-line {
            font-size: 0.78rem;
            color: var(--gray-500);
            line-height: 1.7;
        }

        .detail-card .card-line strong {
            color: var(--gray-700);
            font-weight: 600;
            min-width: 52px;
            display: inline-block;
        }

        /* Table */
        .invoice-table-wrapper {
            margin-bottom: 24px;
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .invoice-table thead th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 11px 12px;
            font-weight: 600;
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.7px;
            text-align: left;
            white-space: nowrap;
        }

        .invoice-table thead th:last-child,
        .invoice-table thead th.text-right {
            text-align: right;
        }

        .invoice-table thead th.text-center {
            text-align: center;
        }

        .invoice-table tbody td {
            padding: 11px 12px;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
            vertical-align: middle;
        }

        .invoice-table tbody tr:last-child td {
            border-bottom: none;
        }

        .invoice-table tbody tr:nth-child(even) {
            background: var(--gray-50);
        }

        .invoice-table tbody tr:hover {
            background: var(--primary-lighter);
        }

        .invoice-table tbody td.text-right {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .invoice-table tbody td.text-center {
            text-align: center;
        }

        .service-name {
            font-weight: 600;
            color: var(--gray-800);
        }

        .service-desc {
            font-size: 0.7rem;
            color: var(--gray-400);
            margin-top: 1px;
        }

        /* Totals */
        .totals-section {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 24px;
        }

        .totals-card {
            width: 340px;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 9px 20px;
            font-size: 0.82rem;
            background: var(--white);
        }

        .totals-row+.totals-row {
            border-top: 1px solid var(--gray-100);
        }

        .totals-row .label {
            color: var(--gray-500);
            font-weight: 500;
        }

        .totals-row .value {
            font-weight: 600;
            color: var(--gray-800);
            font-variant-numeric: tabular-nums;
        }

        .totals-row.grand-total {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 14px 20px;
            border-top: none;
        }

        .totals-row.grand-total .label {
            color: rgba(255, 255, 255, .85);
            font-weight: 700;
            font-size: 0.82rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .totals-row.grand-total .value {
            color: var(--white);
            font-weight: 800;
            font-size: 1.2rem;
        }

        /* Amount Words */
        .amount-words {
            background: var(--primary-lighter);
            border: 1px dashed rgba(30, 115, 190, 0.25);
            border-radius: var(--radius);
            padding: 12px 20px;
            margin-bottom: 24px;
            display: flex;
            gap: 8px;
            align-items: baseline;
        }

        .amount-words .aw-label {
            font-size: 0.68rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--primary);
            letter-spacing: 0.4px;
            white-space: nowrap;
        }

        .amount-words .aw-value {
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--gray-700);
            font-style: italic;
        }

        /* Payment + Status */
        .payment-section {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            margin-bottom: 24px;
            gap: 20px;
        }

        .payment-details {
            flex: 1;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 18px 20px;
        }

        .payment-details .pd-header {
            font-size: 0.68rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.4px;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .payment-details .pd-line {
            font-size: 0.78rem;
            color: var(--gray-500);
            line-height: 1.75;
        }

        .payment-details .pd-line strong {
            color: var(--gray-700);
            font-weight: 600;
            min-width: 110px;
            display: inline-block;
        }

        .payment-status-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border-radius: var(--radius);
            padding: 20px 32px;
            min-width: 160px;
        }

        .payment-status-box.paid-box {
            background: var(--green-50);
            border: 1px solid var(--green-100);
        }

        .payment-status-box.pending-box {
            background: var(--yellow-50);
            border: 1px solid var(--yellow-100);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 24px;
            border-radius: 50px;
            font-weight: 800;
            font-size: 1rem;
            letter-spacing: 2.5px;
            text-transform: uppercase;
        }

        .status-badge.paid {
            background: var(--green-100);
            color: var(--green-700);
            border: 2px solid var(--green-500);
        }

        .status-badge.pending {
            background: var(--yellow-100);
            color: var(--yellow-700);
            border: 2px solid var(--yellow-500);
        }

        .badge-check {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.72rem;
            font-weight: 900;
            color: white;
        }

        .badge-check.paid-check {
            background: var(--green-500);
        }

        .badge-check.pending-check {
            background: var(--yellow-500);
        }

        .status-date {
            font-size: 0.68rem;
            font-weight: 500;
        }

        .status-date.paid-date {
            color: var(--green-600);
        }

        .status-date.pending-date {
            color: var(--yellow-600);
        }

        /* Signature */
        .signature-block {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 24px;
        }

        .signature-area {
            text-align: center;
            width: 220px;
        }

        .signature-area .sig-line {
            border-top: 2px solid var(--gray-300);
            margin-top: 52px;
            margin-bottom: 6px;
        }

        .signature-area .sig-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .signature-area .sig-company {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--gray-600);
            margin-top: 2px;
        }

        /* Terms */
        .terms-section {
            padding: 18px 40px;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
        }

        .terms-section .terms-header {
            font-size: 0.68rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gray-400);
            margin-bottom: 6px;
        }

        .terms-section .terms-list {
            list-style: none;
        }

        .terms-section .terms-list li {
            font-size: 0.7rem;
            color: var(--gray-400);
            padding: 2px 0 2px 14px;
            position: relative;
        }

        .terms-section .terms-list li::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: 700;
        }

        /* Footer */
        .invoice-footer {
            background: var(--gray-900);
            color: var(--gray-400);
            padding: 24px 40px;
            text-align: center;
        }

        .footer-thankyou {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 4px;
        }

        .footer-tagline {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 14px;
        }

        .footer-divider {
            width: 50px;
            height: 3px;
            background: var(--primary);
            margin: 0 auto 14px;
            border-radius: 3px;
        }

        .footer-links {
            font-size: 0.7rem;
            color: var(--gray-500);
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .footer-links span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .footer-links .link-icon {
            font-size: 0.75rem;
        }

        /* Refresh Button */
        .btn-refresh {
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all .2s;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 158, 11, .3);
        }

        .btn-refresh:hover {
            box-shadow: 0 4px 12px rgba(245, 158, 11, .4);
            transform: translateY(-1px);
        }

        /* Generate All Button */
        .btn-generate {
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all .2s;
            background: linear-gradient(135deg, var(--green-500), var(--green-700));
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, .3);
        }

        .btn-generate:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, .4);
            transform: translateY(-1px);
        }

        .btn-generate:disabled {
            opacity: .4;
            cursor: not-allowed;
            transform: none;
        }

        /* Email All Button */
        .btn-email {
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all .2s;
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
            box-shadow: 0 2px 8px rgba(139, 92, 246, .3);
        }

        .btn-email:hover {
            box-shadow: 0 4px 12px rgba(139, 92, 246, .4);
            transform: translateY(-1px);
        }

        .btn-email:disabled {
            opacity: .4;
            cursor: not-allowed;
            transform: none;
        }

        /* Progress Overlay */
        .progress-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-overlay.hidden {
            display: none;
        }

        .progress-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 40px 48px;
            text-align: center;
            box-shadow: var(--shadow-xl);
            min-width: 380px;
            max-width: 480px;
        }

        .progress-card .pc-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .progress-card .pc-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 4px;
        }

        .progress-card .pc-sub {
            font-size: 0.78rem;
            color: var(--gray-400);
            margin-bottom: 20px;
        }

        .progress-bar-track {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 8px;
            transition: width .3s ease;
            width: 0%;
        }

        .progress-card .pc-status {
            font-size: 0.72rem;
            color: var(--gray-500);
            font-weight: 500;
        }

        .progress-card .pc-counter {
            font-size: 0.82rem;
            color: var(--primary);
            font-weight: 700;
            margin-top: 4px;
        }

        /* Print */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .search-panel,
            .empty-state {
                display: none !important;
            }

            .invoice-page {
                display: block !important;
                box-shadow: none;
                border-radius: 0;
                max-width: 100%;
            }

            .invoice-header::before,
            .invoice-header::after {
                display: none;
            }
        }

        /* Responsive */
        @media (max-width: 640px) {
            html {
                font-size: 12px;
            }

            .header-top {
                flex-direction: column;
                gap: 14px;
                padding: 20px;
            }

            .invoice-title-block {
                text-align: left;
            }

            .invoice-meta-bar {
                grid-template-columns: 1fr;
            }

            .meta-item {
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            }

            .meta-item:last-child {
                border-bottom: none;
            }

            .invoice-body {
                padding: 20px;
            }

            .details-grid {
                grid-template-columns: 1fr;
            }

            .invoice-table-wrapper {
                overflow-x: auto;
            }

            .totals-card {
                width: 100%;
            }

            .payment-section {
                flex-direction: column;
            }

            .terms-section,
            .invoice-footer {
                padding-left: 20px;
                padding-right: 20px;
            }

            .search-panel {
                padding: 16px 20px;
            }
        }

        /* ===== RESPONSIVE: TABLETS (max-width: 768px) ===== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            /* Sheet URL bar stacks */
            .sheet-url-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .sheet-url-bar label {
                margin-bottom: 2px;
            }

            .btn-load-sheet {
                justify-content: center;
            }

            /* Search panel header stacks */
            .search-panel-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            /* Buttons wrap into grid */
            .search-actions {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .search-actions button {
                justify-content: center;
                padding: 10px 12px;
                font-size: 0.72rem;
            }

            .search-panel {
                padding: 14px 16px;
                margin-bottom: 16px;
            }

            /* Invoice header stacks */
            .invoice-header .company-brand {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .invoice-header {
                padding: 24px 20px 0;
            }

            .invoice-title-block {
                text-align: center !important;
            }

            .invoice-title {
                font-size: 2rem !important;
            }

            /* Meta bar wraps */
            .meta-bar {
                flex-wrap: wrap;
            }

            .meta-item {
                flex: 1 1 auto;
                min-width: 100px;
                padding: 10px 14px;
            }

            /* Invoice body */
            .invoice-body {
                padding: 16px;
            }

            .details-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .invoice-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .totals-card {
                width: 100%;
            }

            .payment-section {
                flex-direction: column;
                gap: 16px;
            }

            .terms-section,
            .invoice-footer {
                padding-left: 16px;
                padding-right: 16px;
            }

            /* Toast on mobile */
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }

            .toast {
                max-width: 100%;
                font-size: 0.78rem;
                padding: 12px 16px;
            }
        }

        /* ===== RESPONSIVE: SMALL PHONES (max-width: 480px) ===== */
        @media (max-width: 480px) {
            body {
                padding: 6px;
            }

            .search-panel {
                padding: 12px;
                border-radius: 10px;
            }

            /* Buttons stack single column on very small screens */
            .search-actions {
                grid-template-columns: 1fr;
            }

            .sheet-url-input {
                font-size: 0.75rem;
                padding: 8px 10px;
            }

            .search-input {
                font-size: 0.82rem;
                padding: 10px 14px 10px 36px;
            }

            .search-icon {
                left: 10px;
                font-size: 0.95rem;
            }

            .stat-chip {
                font-size: 0.62rem;
                padding: 3px 8px;
            }

            .invoice-page {
                border-radius: 10px;
            }

            .invoice-header {
                padding: 20px 16px 0;
                border-radius: 10px 10px 0 0;
            }

            .brand-name {
                font-size: 1.2rem !important;
            }

            .brand-sub {
                font-size: 0.65rem !important;
            }

            .invoice-title {
                font-size: 1.6rem !important;
            }

            .meta-item {
                padding: 8px 10px;
                min-width: 80px;
            }

            .meta-item .m-label {
                font-size: 0.55rem;
            }

            .meta-item .m-value {
                font-size: 0.78rem;
            }

            .card-header {
                font-size: 0.7rem;
            }

            .invoice-body {
                padding: 12px;
            }

            .footer-links {
                flex-direction: column;
                gap: 6px !important;
            }

            /* Progress overlay card */
            .progress-card {
                margin: 16px;
                padding: 24px 20px;
            }
        }

        /* Sheet URL Input Bar */
        .sheet-url-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
            align-items: center;
        }

        .sheet-url-bar label {
            font-size: 0.72rem;
            font-weight: 700;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            white-space: nowrap;
        }

        .sheet-url-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.82rem;
            color: var(--gray-700);
            outline: none;
            transition: border-color .2s, box-shadow .2s;
            background: var(--gray-50);
        }

        .sheet-url-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 115, 190, .12);
            background: white;
        }

        .btn-load-sheet {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all .2s;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 2px 8px rgba(30, 115, 190, .3);
            white-space: nowrap;
        }

        .btn-load-sheet:hover {
            box-shadow: 0 4px 12px rgba(30, 115, 190, .4);
            transform: translateY(-1px);
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 22px;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            color: white;
            box-shadow: 0 8px 30px rgba(0, 0, 0, .18);
            animation: toastIn .4s ease;
            max-width: 420px;
            line-height: 1.4;
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .toast.success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .toast.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .toast-icon {
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .toast-close {
            margin-left: auto;
            background: none;
            border: none;
            color: rgba(255, 255, 255, .7);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0 0 0 10px;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: white;
        }

        .toast.removing {
            animation: toastOut .3s ease forwards;
        }

        @keyframes toastIn {
            from {
                transform: translateX(120%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toastOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(120%);
                opacity: 0;
            }
        }
    </style>
</head>

<body>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ===== SEARCH PANEL ===== -->
    <div class="search-panel" id="searchPanel">
        <!-- Sheet URL Input -->
        <div class="sheet-url-bar">
            <label>üìä Sheet URL</label>
            <input type="text" class="sheet-url-input" id="sheetUrlInput" placeholder="Paste Google Sheet URL here..."
                value="https://docs.google.com/spreadsheets/d/1A4JZyxJyNJonhJ1ee_CRL8oIPSShde6U1fhB_6PIvZc">
            <button class="btn-load-sheet" onclick="loadSheet()">
                üì• Load Sheet
            </button>
        </div>
        <div class="search-panel-header">
            <div>
                <div class="search-panel-title"><span class="icon">üìÑ</span> Invoice Generator</div>
                <div class="search-panel-subtitle">Search a registered user to generate their GST invoice</div>
            </div>
            <div class="search-actions">
                <button class="btn-refresh" id="btnRefresh" onclick="fetchData()"
                    title="Refresh data from Google Sheets">
                    üîÑ Refresh
                </button>
                <button class="btn-email" id="btnEmailAll" disabled onclick="emailAllInvoices()">
                    üìß Email All
                </button>
                <button class="btn-generate" id="btnGenerateAll" disabled onclick="generateAllInvoices()">
                    üì¶ Generate All
                </button>
                <button class="btn-print" id="btnPrint" disabled onclick="window.print()">
                    üñ®Ô∏è Print Invoice
                </button>
            </div>
        </div>
        <div class="search-wrapper">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="searchInput" placeholder="Search by name, email, ID or phone..."
                autocomplete="off">
            <div class="search-dropdown" id="searchDropdown"></div>
        </div>
        <div class="search-stats" id="searchStats"></div>
        <div class="loading-bar" id="loadingBar"></div>
    </div>

    <!-- ===== PROGRESS OVERLAY ===== -->
    <div class="progress-overlay hidden" id="progressOverlay">
        <div class="progress-card">
            <div class="pc-icon">üßæ</div>
            <div class="pc-title">Generating Invoice Images</div>
            <div class="pc-sub">Please wait while we generate images for all users...</div>
            <div class="progress-bar-track">
                <div class="progress-bar-fill" id="progressFill"></div>
            </div>
            <div class="pc-status" id="progressStatus">Starting...</div>
            <div class="pc-counter" id="progressCounter">0 / 0</div>
        </div>
    </div>

    <!-- ===== EMPTY STATE ===== -->
    <div class="empty-state" id="emptyState">
        <div class="empty-icon">üßæ</div>
        <div class="empty-title">No Invoice Selected</div>
        <div class="empty-desc">Search for a registered user above to generate and view their invoice.</div>
    </div>

    <!-- ===== INVOICE ===== -->
    <div class="invoice-page" id="invoicePage">
        <div class="invoice-header">
            <div class="header-top">
                <div class="company-brand">
                    <div class="logo-container">
                        <img src="logo.png" alt="PadosiAgents">
                    </div>
                    <div class="brand-text">
                        <div class="brand-name">PadosiAgents</div>
                        <div class="brand-sub">PadosiAgent ServTech Pvt Ltd</div>
                    </div>
                </div>
                <div class="invoice-title-block">
                    <div class="invoice-title">Invoice</div>
                    <div class="invoice-title-sub">Tax Invoice / GST Bill of Supply</div>
                </div>
            </div>
            <div class="invoice-meta-bar">
                <div class="meta-item">
                    <div class="m-label">Invoice Number</div>
                    <div class="m-value" id="invNumber">‚Äî</div>
                </div>
                <div class="meta-item">
                    <div class="m-label">Invoice Date</div>
                    <div class="m-value" id="invDate">‚Äî</div>
                </div>
                <div class="meta-item">
                    <div class="m-label">Due Date</div>
                    <div class="m-value" id="invDueDate">‚Äî</div>
                </div>
            </div>
        </div>

        <div class="invoice-body">
            <!-- FROM / BILL TO -->
            <div class="details-grid">
                <div class="detail-card">
                    <div class="card-header"><span class="card-header-icon">üè¢</span> From</div>
                    <div class="card-title">PadosiAgent ServTech Pvt Ltd</div>
                    <div class="card-line">123, Tech Park, Sector 62</div>
                    <div class="card-line">Noida, Uttar Pradesh ‚Äì 201301</div>
                    <div class="card-line" style="margin-top:8px"><strong>GSTIN:</strong> 09AABCP1234A1Z5</div>
                    <div class="card-line"><strong>PAN:</strong> AABCP1234A</div>
                    <div class="card-line"><strong>Email:</strong> billing@padosiagent.com</div>
                    <div class="card-line"><strong>Phone:</strong> +91 98765 43210</div>
                    <div class="card-line"><strong>Web:</strong> www.padosiagent.com</div>
                </div>
                <div class="detail-card">
                    <div class="card-header"><span class="card-header-icon">üìã</span> Bill To</div>
                    <div class="card-title" id="billToName">‚Äî</div>
                    <div class="card-line" id="billToEmail"></div>
                    <div class="card-line" id="billToPhone"></div>
                    <div class="card-line" id="billToPAN"></div>
                    <div class="card-line" id="billToTypes"></div>
                </div>
            </div>

            <!-- Table -->
            <div class="invoice-table-wrapper">
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th style="width:4%">#</th>
                            <th style="width:22%">Service</th>
                            <th style="width:18%">Description</th>
                            <th class="text-center" style="width:8%">HSN/SAC</th>
                            <th class="text-center" style="width:5%">Qty</th>
                            <th class="text-right" style="width:11%">Rate (‚Çπ)</th>
                            <th class="text-right" style="width:10%">CGST (‚Çπ)</th>
                            <th class="text-right" style="width:10%">SGST (‚Çπ)</th>
                            <th class="text-right" style="width:12%">Amount (‚Çπ)</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceTableBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Totals -->
            <div class="totals-section">
                <div class="totals-card">
                    <div class="totals-row">
                        <span class="label">Sub Total</span>
                        <span class="value" id="subTotal">‚Äî</span>
                    </div>
                    <div class="totals-row">
                        <span class="label">CGST @ 9%</span>
                        <span class="value" id="cgstTotal">‚Äî</span>
                    </div>
                    <div class="totals-row">
                        <span class="label">SGST @ 9%</span>
                        <span class="value" id="sgstTotal">‚Äî</span>
                    </div>
                    <div class="totals-row grand-total">
                        <span class="label">Total Amount</span>
                        <span class="value" id="grandTotal">‚Äî</span>
                    </div>
                </div>
            </div>

            <!-- Amount in Words -->
            <div class="amount-words">
                <span class="aw-label">Amount in Words:</span>
                <span class="aw-value" id="amountWords">‚Äî</span>
            </div>

            <!-- Payment + Status -->
            <div class="payment-section">
                <div class="payment-details">
                    <div class="pd-header"><span class="card-header-icon">üè¶</span> Payment Details</div>
                    <div class="pd-line"><strong>Razorpay Order:</strong> <span id="payOrderId">‚Äî</span></div>
                    <div class="pd-line"><strong>Razorpay Payment:</strong> <span id="payPaymentId">‚Äî</span></div>
                    <div class="pd-line"
                        style="margin-top:10px; border-top: 1px solid var(--gray-200); padding-top: 10px;">
                        <strong>Bank (Payee):</strong> PadosiAgent ServTech Pvt Ltd
                    </div>
                    <div class="pd-line"><strong>Account No:</strong> 9876543210123456</div>
                    <div class="pd-line"><strong>IFSC Code:</strong> SBIN0012345</div>
                    <div class="pd-line"><strong>Bank:</strong> State Bank of India</div>
                </div>
                <div class="payment-status-box" id="paymentStatusBox">
                    <div class="status-badge" id="statusBadge">‚Äî</div>
                    <div class="status-date" id="statusDate">‚Äî</div>
                </div>
            </div>

            <!-- Signature -->
            <div class="signature-block">
                <div class="signature-area">
                    <div class="sig-line"></div>
                    <div class="sig-label">Authorised Signatory</div>
                    <div class="sig-company">PadosiAgent ServTech Pvt Ltd</div>
                </div>
            </div>
        </div>

        <!-- Terms -->
        <div class="terms-section">
            <div class="terms-header">Terms &amp; Conditions</div>
            <ul class="terms-list">
                <li>Payment is due within 30 days of invoice date.</li>
                <li>Late payments attract interest at 1.5% per month.</li>
                <li>This is a computer-generated invoice and does not require a physical signature.</li>
                <li>Subject to jurisdiction of courts in Noida, Uttar Pradesh.</li>
            </ul>
        </div>

        <!-- Footer -->
        <div class="invoice-footer">
            <div class="footer-thankyou">Thank you for your business!</div>
            <div class="footer-tagline">Your trusted neighbourhood insurance technology partner.</div>
            <div class="footer-divider"></div>
            <div class="footer-links">
                <span><span class="link-icon">üåê</span> www.padosiagent.com</span>
                <span><span class="link-icon">‚úâÔ∏è</span> billing@padosiagent.com</span>
                <span><span class="link-icon">üìû</span> +91 98765 43210</span>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIG =====
        const DEFAULT_SHEET_ID = '1A4JZyxJyNJonhJ1ee_CRL8oIPSShde6U1fhB_6PIvZc';
        let currentSheetId = DEFAULT_SHEET_ID;
        let csvUrl = `https://docs.google.com/spreadsheets/d/${currentSheetId}/gviz/tq?tqx=out:csv`;

        let allUsers = [];

        // ===== TOAST NOTIFICATIONS =====
        function showToast(message, type = 'error', duration = 5000) {
            const container = document.getElementById('toastContainer');
            const icons = { error: '‚ùå', success: '‚úÖ', warning: '‚ö†Ô∏è' };
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || '‚ùå'}</span>
                <span>${message}</span>
                <button class="toast-close" onclick="this.parentElement.classList.add('removing'); setTimeout(() => this.parentElement.remove(), 300);">‚úï</button>
            `;
            container.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.add('removing');
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
        }

        // ===== EXTRACT SHEET ID FROM URL =====
        function extractSheetId(url) {
            // Matches: https://docs.google.com/spreadsheets/d/SHEET_ID/...
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
            return match ? match[1] : null;
        }

        function loadSheet() {
            const input = document.getElementById('sheetUrlInput').value.trim();
            if (!input) {
                showToast('Please paste a Google Sheet URL.', 'warning');
                return;
            }

            const sheetId = extractSheetId(input);
            if (!sheetId) {
                showToast('Invalid Google Sheet URL. Paste a link like: https://docs.google.com/spreadsheets/d/SHEET_ID/edit', 'error');
                return;
            }

            currentSheetId = sheetId;
            csvUrl = `https://docs.google.com/spreadsheets/d/${currentSheetId}/gviz/tq?tqx=out:csv`;
            console.log('Loading sheet:', currentSheetId);
            fetchData();
        }

        // ===== DOM REFS =====
        const searchInput = document.getElementById('searchInput');
        const searchDropdown = document.getElementById('searchDropdown');
        const invoicePage = document.getElementById('invoicePage');
        const emptyState = document.getElementById('emptyState');
        const loadingBar = document.getElementById('loadingBar');
        const btnPrint = document.getElementById('btnPrint');
        const searchStats = document.getElementById('searchStats');

        // ===== CSV PARSER =====
        function parseCSV(text) {
            const rows = [];
            let current = '';
            let inQuotes = false;
            let row = [];

            for (let i = 0; i < text.length; i++) {
                const ch = text[i];
                if (inQuotes) {
                    if (ch === '"') {
                        if (i + 1 < text.length && text[i + 1] === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = false;
                        }
                    } else {
                        current += ch;
                    }
                } else {
                    if (ch === '"') {
                        inQuotes = true;
                    } else if (ch === ',') {
                        row.push(current.trim());
                        current = '';
                    } else if (ch === '\n' || ch === '\r') {
                        if (ch === '\r' && i + 1 < text.length && text[i + 1] === '\n') i++;
                        row.push(current.trim());
                        if (row.length > 1 || row[0] !== '') rows.push(row);
                        row = [];
                        current = '';
                    } else {
                        current += ch;
                    }
                }
            }
            row.push(current.trim());
            if (row.length > 1 || row[0] !== '') rows.push(row);
            return rows;
        }

        function csvToObjects(rows) {
            if (rows.length < 2) return [];
            const headers = rows[0];
            return rows.slice(1).map(row => {
                const obj = {};
                headers.forEach((h, i) => {
                    obj[h] = row[i] || '';
                });
                return obj;
            });
        }

        // ===== DATE HELPERS =====
        function excelSerialToDate(serial) {
            const num = parseInt(serial);
            if (isNaN(num) || num === 0) return new Date();
            // Excel serial date: days since Jan 0 1900
            // But Google Sheets uses Jan 0 1900 epoch same as Excel
            const epoch = new Date(1899, 11, 30); // Dec 30 1899
            const date = new Date(epoch.getTime() + num * 86400000);
            return date;
        }

        function formatDate(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function addDays(date, days) {
            const d = new Date(date);
            d.setDate(d.getDate() + days);
            return d;
        }

        // ===== NUMBER TO WORDS =====
        function numberToWords(num) {
            if (num === 0) return 'Zero';
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine',
                'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen',
                'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

            function convert(n) {
                if (n < 20) return ones[n];
                if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? ' ' + ones[n % 10] : '');
                if (n < 1000) return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 ? ' and ' + convert(n % 100) : '');
                if (n < 100000) return convert(Math.floor(n / 1000)) + ' Thousand' + (n % 1000 ? ' ' + convert(n % 1000) : '');
                if (n < 10000000) return convert(Math.floor(n / 100000)) + ' Lakh' + (n % 100000 ? ' ' + convert(n % 100000) : '');
                return convert(Math.floor(n / 10000000)) + ' Crore' + (n % 10000000 ? ' ' + convert(n % 10000000) : '');
            }

            const intPart = Math.floor(num);
            const decPart = Math.round((num - intPart) * 100);

            let result = 'Rupees ' + convert(intPart);
            if (decPart > 0) {
                result += ' and ' + convert(decPart) + ' Paise';
            }
            result += ' Only';
            return result;
        }

        // ===== FORMAT CURRENCY =====
        function fmt(n) {
            const num = parseFloat(n);
            if (isNaN(num)) return '0.00';
            return num.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // ===== PARSE SELECTED PLAN JSON =====
        function parsePlan(jsonStr) {
            if (!jsonStr) return null;
            try {
                return JSON.parse(jsonStr);
            } catch (e) {
                return null;
            }
        }

        // ===== FORMAT USER TYPES =====
        function formatUserTypes(raw) {
            if (!raw) return '';
            try {
                const arr = JSON.parse(raw);
                return arr.map(t => t.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())).join(', ');
            } catch (e) {
                return raw;
            }
        }

        // ===== FETCH DATA (with retry) =====
        async function fetchWithRetry(url, retries = 3) {
            // Add cache-busting timestamp to always get fresh data
            const bustUrl = url + '&_t=' + Date.now();
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(bustUrl, { cache: 'no-store' });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.text();
                } catch (e) {
                    console.warn(`Fetch attempt ${i + 1}/${retries} failed:`, e.message);
                    if (i === retries - 1) throw e;
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i))); // 1s, 2s, 4s
                }
            }
        }

        async function fetchData() {
            loadingBar.classList.remove('hidden');
            searchStats.innerHTML = `<span class="stat-chip">‚è≥ Loading data from Google Sheets...</span>`;
            try {
                const text = await fetchWithRetry(csvUrl);
                const rows = parseCSV(text);
                allUsers = csvToObjects(rows);

                // Deduplicate by keeping last entry per ID
                const map = new Map();
                allUsers.forEach(u => {
                    const id = u['ID'];
                    if (id) map.set(id, u);
                });
                allUsers = Array.from(map.values());

                // Show stats
                const completed = allUsers.filter(u => u['Payment Status'] === 'completed').length;
                const pending = allUsers.filter(u => u['Payment Status'] === 'pending').length;
                searchStats.innerHTML = `
            <span class="stat-chip"><span class="num">${allUsers.length}</span> Total Users</span>
            <span class="stat-chip"><span class="num">${completed}</span> Paid</span>
            <span class="stat-chip"><span class="num">${pending}</span> Pending</span>
        `;
                // Enable Generate All & Email All buttons
                document.getElementById('btnGenerateAll').disabled = false;
                document.getElementById('btnEmailAll').disabled = false;
            } catch (e) {
                searchStats.innerHTML = `<span class="stat-chip" style="color:var(--red-500)">‚ö†Ô∏è Failed to load data. <a href="#" onclick="event.preventDefault(); fetchData();" style="color:#3b82f6;text-decoration:underline;cursor:pointer;">Retry</a></span>`;
                console.error('Fetch error:', e);

                // Show toast with specific error message
                let msg = 'Could not load Google Sheet data.';
                if (e.message.includes('HTTP 401') || e.message.includes('HTTP 403')) {
                    msg = 'This Google Sheet is private or not shared. Please make it public (Anyone with the link ‚Üí Viewer).';
                } else if (e.message.includes('HTTP 404')) {
                    msg = 'Google Sheet not found. Please check the URL and try again.';
                } else if (e.message.includes('Failed to fetch') || e.message.includes('ERR_')) {
                    msg = 'Network error ‚Äî check your internet connection and try again.';
                } else {
                    msg = `Failed to load sheet: ${e.message}`;
                }
                showToast(msg, 'error');
            }
            loadingBar.classList.add('hidden');
        }

        // ===== SEARCH =====
        searchInput.addEventListener('input', function () {
            const q = this.value.trim().toLowerCase();
            if (q.length < 1) {
                searchDropdown.classList.remove('open');
                return;
            }

            const matches = allUsers.filter(u => {
                return (u['Full Name'] || '').toLowerCase().includes(q) ||
                    (u['Email'] || '').toLowerCase().includes(q) ||
                    (u['ID'] || '').toLowerCase().includes(q) ||
                    (u['Mobile'] || '').includes(q);
            }).slice(0, 15);

            if (matches.length === 0) {
                searchDropdown.innerHTML = '<div style="padding:16px;text-align:center;color:var(--gray-400);font-size:0.82rem;">No results found</div>';
                searchDropdown.classList.add('open');
                return;
            }

            searchDropdown.innerHTML = matches.map((u, i) => {
                const isPaid = u['Payment Status'] === 'completed';
                const amount = u['Registration Amount (‚Çπ)'] || '0';
                return `<div class="search-item" data-index="${allUsers.indexOf(u)}">
            <div class="search-item-left">
                <span class="search-item-name">#${u['ID']} ‚Äî ${u['Full Name'] || 'N/A'}</span>
                <span class="search-item-email">${u['Email'] || ''} | ${u['Mobile'] || ''}</span>
            </div>
            <div class="search-item-right">
                <span class="search-item-amount">‚Çπ${fmt(amount)}</span>
                <span class="search-item-badge ${isPaid ? 'badge-completed' : 'badge-pending'}">${isPaid ? 'Paid' : 'Pending'}</span>
            </div>
        </div>`;
            }).join('');

            searchDropdown.classList.add('open');

            // Click handlers
            searchDropdown.querySelectorAll('.search-item').forEach(item => {
                item.addEventListener('click', () => {
                    const idx = parseInt(item.dataset.index);
                    selectUser(allUsers[idx]);
                    searchDropdown.classList.remove('open');
                });
            });
        });

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-wrapper')) {
                searchDropdown.classList.remove('open');
            }
        });

        // ===== SELECT USER & POPULATE INVOICE =====
        function selectUser(user) {
            // Update search input
            searchInput.value = `#${user['ID']} ‚Äî ${user['Full Name']}`;

            // Invoice number
            const id = user['ID'] || '0';
            document.getElementById('invNumber').textContent = `PA-2026-${id.padStart(3, '0')}`;

            // Dates
            const createdSerial = user['Created At'];
            const invDate = excelSerialToDate(createdSerial);
            const dueDate = addDays(invDate, 30);
            document.getElementById('invDate').textContent = formatDate(invDate);
            document.getElementById('invDueDate').textContent = formatDate(dueDate);

            // Bill To
            document.getElementById('billToName').textContent = user['Full Name'] || 'N/A';
            document.getElementById('billToEmail').innerHTML = user['Email'] ? `<strong>Email:</strong> ${user['Email']}` : '';
            document.getElementById('billToPhone').innerHTML = user['Mobile'] ? `<strong>Phone:</strong> +91 ${user['Mobile']}` : '';
            document.getElementById('billToPAN').innerHTML = user['PAN Number'] ? `<strong>PAN:</strong> ${user['PAN Number']}` : '';

            const types = formatUserTypes(user['User Types']);
            document.getElementById('billToTypes').innerHTML = types ? `<strong>Type:</strong> ${types}` : '';

            // Parse plan
            const plan = parsePlan(user['Selected Plan']);
            const regAmount = parseFloat(user['Registration Amount (‚Çπ)']) || 0;

            let baseAmount, gstAmount, totalAmount, planName, planType;

            if (plan) {
                baseAmount = parseFloat(plan.base_amount) || 0;
                gstAmount = parseFloat(plan.gst_amount) || 0;
                totalAmount = parseFloat(plan.total_amount) || regAmount;
                planName = plan.name || 'Subscription Plan';
                planType = plan.type || 'basic';
            } else {
                totalAmount = regAmount;
                baseAmount = totalAmount / 1.18; // Derive base from total (18% GST)
                gstAmount = totalAmount - baseAmount;
                planName = 'Subscription Plan';
                planType = 'basic';
            }

            const cgst = gstAmount / 2;
            const sgst = gstAmount / 2;

            // Service description
            const services = user['Desired Services'] || '';
            const serviceDesc = services.replace(/\|/g, ', ').replace(/_/g, ' ').trim() || 'Platform subscription services';

            // Table body
            document.getElementById('invoiceTableBody').innerHTML = `
        <tr>
            <td class="text-center">1</td>
            <td>
                <div class="service-name">${planName}</div>
                <div class="service-desc">${planType.charAt(0).toUpperCase() + planType.slice(1)} Plan</div>
            </td>
            <td>${serviceDesc.length > 50 ? serviceDesc.substring(0, 50) + '‚Ä¶' : serviceDesc}</td>
            <td class="text-center">998314</td>
            <td class="text-center">1</td>
            <td class="text-right">${fmt(baseAmount)}</td>
            <td class="text-right">${fmt(cgst)}</td>
            <td class="text-right">${fmt(sgst)}</td>
            <td class="text-right" style="font-weight:700">${fmt(totalAmount)}</td>
        </tr>
    `;

            // Totals
            document.getElementById('subTotal').textContent = `‚Çπ${fmt(baseAmount)}`;
            document.getElementById('cgstTotal').textContent = `‚Çπ${fmt(cgst)}`;
            document.getElementById('sgstTotal').textContent = `‚Çπ${fmt(sgst)}`;
            document.getElementById('grandTotal').textContent = `‚Çπ${fmt(totalAmount)}`;

            // Amount in words
            document.getElementById('amountWords').textContent = numberToWords(totalAmount);

            // Payment info
            const orderId = user['Razorpay Order ID'] || '‚Äî';
            const paymentId = user['Razorpay Payment ID'] || '‚Äî';
            document.getElementById('payOrderId').textContent = orderId;
            document.getElementById('payPaymentId').textContent = paymentId;

            // Payment status
            const isPaid = user['Payment Status'] === 'completed';
            const statusBox = document.getElementById('paymentStatusBox');
            const statusBadge = document.getElementById('statusBadge');
            const statusDate = document.getElementById('statusDate');

            statusBox.className = 'payment-status-box ' + (isPaid ? 'paid-box' : 'pending-box');
            statusBadge.className = 'status-badge ' + (isPaid ? 'paid' : 'pending');
            statusBadge.innerHTML = `<span class="badge-check ${isPaid ? 'paid-check' : 'pending-check'}">${isPaid ? '‚úì' : '‚è≥'}</span> ${isPaid ? 'PAID' : 'PENDING'}`;

            statusDate.className = 'status-date ' + (isPaid ? 'paid-date' : 'pending-date');
            statusDate.textContent = isPaid ? `Paid via Razorpay` : 'Payment Pending';

            // Show invoice
            invoicePage.classList.add('visible');
            emptyState.classList.add('hidden');
            btnPrint.disabled = false;

            // Scroll to invoice
            invoicePage.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ===== INIT =====
        fetchData();
    </script>

    <!-- html2canvas & JSZip for batch image generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        async function generateAllInvoices() {
            if (allUsers.length === 0) return alert('No users loaded yet.');

            const overlay = document.getElementById('progressOverlay');
            const fill = document.getElementById('progressFill');
            const status = document.getElementById('progressStatus');
            const counter = document.getElementById('progressCounter');
            const btnGen = document.getElementById('btnGenerateAll');

            // Disable buttons
            btnGen.disabled = true;
            document.getElementById('btnPrint').disabled = true;

            // Show overlay
            overlay.classList.remove('hidden');
            fill.style.width = '0%';
            counter.textContent = `0 / ${allUsers.length}`;

            // Show invoice for rendering
            invoicePage.classList.add('visible');
            emptyState.classList.add('hidden');

            const zip = new JSZip();
            const imgFolder = zip.folder('invoices');

            for (let i = 0; i < allUsers.length; i++) {
                const user = allUsers[i];
                const name = (user['Full Name'] || 'User_' + user['ID']).replace(/[^a-zA-Z0-9_ ]/g, '').trim();
                const id = user['ID'] || i;

                // Update progress
                const pct = Math.round(((i + 1) / allUsers.length) * 100);
                fill.style.width = pct + '%';
                status.textContent = `Processing: #${id} ‚Äî ${user['Full Name'] || 'N/A'}`;
                counter.textContent = `${i + 1} / ${allUsers.length}`;

                // Populate invoice with this user
                selectUser(user);

                // Wait for render
                await new Promise(r => setTimeout(r, 150));

                // Capture
                try {
                    const canvas = await html2canvas(invoicePage, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false
                    });
                    const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
                    const fileName = `Invoice_${String(id).padStart(3, '0')}_${name.replace(/\s+/g, '_')}.png`;
                    imgFolder.file(fileName, blob);
                } catch (err) {
                    console.error(`Failed for user #${id}:`, err);
                }
            }

            // Generate ZIP
            status.textContent = 'üì¶ Creating ZIP file...';
            fill.style.width = '100%';

            try {
                const zipBlob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });

                // Download
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'PadosiAgent_All_Invoices.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                status.textContent = `‚úÖ Done! ${allUsers.length} invoices generated.`;
            } catch (err) {
                status.textContent = '‚ùå Error creating ZIP.';
                console.error('ZIP error:', err);
            }

            // Re-enable buttons after 2s
            setTimeout(() => {
                overlay.classList.add('hidden');
                btnGen.disabled = false;
            }, 2000);
        }
    </script>

    <!-- Email All Invoices -->
    <script>
        async function emailAllInvoices() {
            const overlay = document.getElementById('progressOverlay');
            const fill = document.getElementById('progressFill');
            const status = document.getElementById('progressStatus');
            const counter = document.getElementById('progressCounter');
            const title = overlay.querySelector('.pc-title');
            const sub = overlay.querySelector('.pc-sub');
            const btnEmail = document.getElementById('btnEmailAll');

            // Update overlay text for email mode
            title.textContent = 'üìß Emailing Invoices';
            sub.textContent = 'Generating and emailing invoices to all customers...';
            overlay.classList.remove('hidden');
            fill.style.width = '0%';
            btnEmail.disabled = true;

            let sent = 0, failed = 0, skipped = 0;

            for (let i = 0; i < allUsers.length; i++) {
                const user = allUsers[i];
                const name = user['Full Name'] || 'Unknown';
                const email = user['Email'] || '';
                const id = user['ID'] || (i + 1);
                const invoiceNumber = `PA-2026-${String(id).padStart(3, '0')}`;

                const pct = Math.round(((i + 1) / allUsers.length) * 100);
                fill.style.width = pct + '%';
                counter.textContent = `${i + 1} / ${allUsers.length}`;

                // Skip users without email
                if (!email || !email.includes('@')) {
                    status.textContent = `‚è≠Ô∏è Skipping ${name} (no email)`;
                    skipped++;
                    continue;
                }

                status.textContent = `üìß Emailing ${name} (${email})...`;

                try {
                    // Populate invoice for this user
                    selectUser(user);
                    await new Promise(r => setTimeout(r, 200));

                    // Capture invoice as image
                    const invoicePage = document.getElementById('invoicePage');
                    const canvas = await html2canvas(invoicePage, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false
                    });
                    const imageBase64 = canvas.toDataURL('image/png');

                    // Send to API
                    const res = await fetch('/api/send-invoice', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: email,
                            name: name,
                            invoiceNumber: invoiceNumber,
                            imageBase64: imageBase64
                        })
                    });

                    const data = await res.json();
                    if (data.success) {
                        sent++;
                        status.textContent = `‚úÖ Sent to ${name} (${email})`;
                    } else {
                        failed++;
                        status.textContent = `‚ùå Failed: ${name} ‚Äî ${data.error || 'Unknown error'}`;
                    }
                } catch (err) {
                    failed++;
                    status.textContent = `‚ùå Error: ${name} ‚Äî ${err.message}`;
                    console.error(`Email failed for ${name}:`, err);
                }

                // Small delay between emails to avoid rate limiting
                await new Promise(r => setTimeout(r, 500));
            }

            // Final summary
            fill.style.width = '100%';
            status.textContent = `‚úÖ Done! ${sent} sent, ${failed} failed, ${skipped} skipped (no email).`;

            // Reset overlay text and re-enable button after 3s
            setTimeout(() => {
                overlay.classList.add('hidden');
                title.textContent = 'Generating Invoice Images';
                sub.textContent = 'Please wait while we generate images for all users...';
                btnEmail.disabled = false;
            }, 3000);
        }
    </script>

</body>

</html>